# Angular Webpack lazyStyleTag issue

This project was generated with [Angular CLI](https://github.com/angular/angular-cli) version 12.2.18.

![node](https://img.shields.io/badge/node-%5E14.20.1-brightgreen)
![npm](https://img.shields.io/badge/npm-%5E6.14.17-blue)

This project is meant to reproduce an issue with lazy-loaded stylesheets in an Angular app.

## Why do we need lazy-loaded stylesheets?

Our application has to support multiple different stylesheets,
which can be very different in terms of color, typography and layout.
These stylesheets (we call them "themes", although they are far from being "just themes"...)
are developed independently and distributed as npm packages.

For each "theme" to be used, our Angular application implements a separate SCSS file
to implement our naming convention required for Webpack (more on that later),
e.g. `stylesheet-a.theme.scss`.

The required webpack rules are added using the npm package
[@angular-builders/custom-webpack](https://www.npmjs.com/package/@angular-builders/custom-webpack/v/13.1.0).

This solution has been successfully implemented on Angular 12.
Now, after migrating to Angular 13, the resolution of the assets
(to be precise, the font files) doesn't work anymore.

The font files are part of the theme bundles and are referenced there as follows:
```
@font-face {
 src: url(~@scope/theme-a/fonts/font-a.woff) format('woff');
}
```

On Angular 12, these font files were correctly copied from the `node_modules`
to the `dist` directory of our app, the `url(...)` paths were correctly adjusted.

Since Angular 13, neither the paths are adjusted nor the files are copied.

## How is it implemented?

For the sake of simplicity, I have not used any theme packages in this example.
Instead, I include the font files from `material-icons` into a stylesheet,
which is to be lazy-loaded.

### Step 1: prepare the stylesheet

- installed `material-icons` as dependency
- created stylesheet `src/test.theme.scss`
- created `@font-face` declaration and some test classes in `src/test.theme.scss`

### Step 2: setup webpack config

- installed `@angular-builders/custom-webpack` as dev dependency
- configured `custom-webpack` builders in `angular.json`
- added `custom-webpack.config.js`

The custom webpack config function has to tweak the webpack configuration
generated by Angular. It adds an `exclude` to the default scss ruleset (`test: /\.(scss)$/i`),
such that scss files following the naming convention `*.theme.scss` won't be handled
by the default Angular webpack config.

Then, it appends a new ruleset for our naming convention (`/\.(theme\.scss)$/i`).
This ruleset basically defines the following loaders: `['style-loader', 'css-loader', 'sass-loader']`.
The `style-loader` is provided with the `injectType: 'lazyStyleTag'` option.

On Angular 12, this was enough, but with Angular 13 I got node module resolution errors.
Thus, I've applied the `includePath: ['node_modules']` sass option to the `sass-loader`.

### Step 3: import and use the stylesheet

Next, the theme stylesheet is imported from the `app.component.ts` file
and - being optimistic - its `use()` method is being called on initialization.

This should succeed if the described webpack config is effective (_and it does!_).

The template of the `AppComponent` implements a little content using the css classes
from the theme stylesheet.

## Building the application

```
npm run build
```

On Angular 12, this command would compile the app code to the `dist` directory.
The assets (font files) used to be present in the `dist` directory.

Since Angular 13, only assets referenced from the regular `styles.scss` are present.
The assets referenced by the lazy-loaded stylesheet are not copied to
the `dist` directory.

## Running the application

```
npm run start
```

When running the application, text in the app component should be red and a search
icon should be displayed.

With Angular 12, this was the case. Since the Angular 13 upgrade
I get the following error in the browser console:
```
GET http://localhost:4200/~material-icons/iconfont/material-icons.woff net::ERR_ABORTED 404 (Not Found)
```
